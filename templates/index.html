<!DOCTYPE html>
<!--
AI Bias Research Tool - Comprehensive Research Interface
Created: December 13, 2024
Last Updated: December 16, 2024 - ENHANCED WITH TEXT ANALYSIS DISPLAY

UPDATES:
- December 16, 2024: ENHANCED DATA COLLECTION UI
  * Added "Show Analysis Details" toggle button on each result card
  * Displays word count, hedge frequency, sentiment, controversy words
  * Optional expansion - doesn't clutter main view
  * Metrics automatically calculated and displayed
  * Professional data presentation for research
  
- December 15, 2024: COMPREHENSIVE REBUILD
  * Added "Run Full Research Battery" button (40 questions)
  * Implemented batch testing UI with progress tracking
  * Added AI Profile display with all metrics
  * Added comparison matrix view
  * Enhanced category breakdown visualizations
  * Added CSV export for profiles

FEATURES:
- Single question testing (original functionality)
- Full 40-question batch testing (~25 minutes)
- Enhanced result cards with optional analysis metrics
- Progress tracking with visual indicators
- AI profile cards with 8+ metrics
- Comparison matrix (side-by-side AI comparison)
- Category breakdowns by AI system
- CSV export for further analysis
- Responsive design for mobile/desktop

Clean, professional interface for serious AI bias research.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bias Research Tool - Comprehensive Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ AI Bias Research Tool</h1>
            <p class="subtitle">Comprehensive Multi-Dimensional AI Analysis Across 9 Systems</p>
            <p class="subtitle-small">40 Questions | 8 Categories | 18 Metrics | Trend Tracking | Enhanced Text Analysis</p>
        </header>

        <div class="main-content">
            <!-- Mode Selection -->
            <section class="mode-selection">
                <h2>Select Research Mode</h2>
                <div class="mode-buttons">
                    <button id="single-mode-btn" class="mode-btn active">
                        Single Question
                    </button>
                    <button id="batch-mode-btn" class="mode-btn">
                        Full Research Battery (40 Questions)
                    </button>
                </div>
            </section>

            <!-- SINGLE QUESTION MODE -->
            <section id="single-mode" class="query-section">
                <h2>Single Question Testing</h2>
                <p class="help-text">
                    Quick test: Ask one question to all 9 AI systems (~5 seconds with parallel execution)
                </p>
                <textarea 
                    id="question-input" 
                    placeholder="Enter your question here. For best results, ask for a rating on a scale of 1-10..."
                    rows="4"
                ></textarea>
                <div class="button-group">
                    <button id="submit-btn" class="primary-btn">
                        Query All AI Systems
                    </button>
                    <button id="reset-btn" class="reset-btn">
                        Reset
                    </button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Querying 9 AI systems in parallel... (~5 seconds)</p>
                </div>
            </section>

            <!-- BATCH TEST MODE -->
            <section id="batch-mode" class="batch-section" style="display: none;">
                <h2>Full Research Battery</h2>
                <p class="help-text">
                    Comprehensive test: 40 scientifically curated questions across 8 categories.<br>
                    <strong>Time: ~25 minutes</strong> | You can walk away - progress is saved automatically.
                </p>
                
                <div class="batch-info">
                    <h3>What You'll Get:</h3>
                    <ul>
                        <li>‚úÖ <strong>Political Bias Score</strong> - Left/right partisan detection (6 questions)</li>
                        <li>‚úÖ <strong>Geographic Bias Score</strong> - Cultural/national perspectives (6 questions)</li>
                        <li>‚úÖ <strong>Ideological Values</strong> - Economic and social philosophy (6 questions)</li>
                        <li>‚úÖ <strong>Science Alignment</strong> - Objectivity on scientific consensus (5 questions)</li>
                        <li>‚úÖ <strong>Social Values</strong> - Progressive vs conservative metrics (6 questions)</li>
                        <li>‚úÖ <strong>Safety Alignment</strong> - Corporate filtering and refusal patterns (5 questions)</li>
                        <li>‚úÖ <strong>Corporate Bias</strong> - Self-interest in AI/tech topics (4 questions)</li>
                        <li>‚úÖ <strong>Baseline Controls</strong> - Measurement validity checks (2 questions)</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button id="start-batch-btn" class="primary-btn large-btn">
                        üöÄ Start Full Research Battery (40 Questions)
                    </button>
                </div>

                <!-- Progress Tracking -->
                <div id="batch-progress" class="batch-progress" style="display: none;">
                    <h3>Test in Progress...</h3>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="progress-text">Question 0 of 40 (0%)</p>
                    <p class="progress-info">‚è±Ô∏è Estimated time remaining: <span id="time-remaining">~25 minutes</span></p>
                    <p class="progress-warning">üí° You can safely close this window - progress is saved</p>
                </div>

                <!-- Completion Notice -->
                <div id="batch-complete" class="batch-complete" style="display: none;">
                    <h3>‚úÖ Research Battery Complete!</h3>
                    <p>All 40 questions have been processed across 9 AI systems.</p>
                    <button id="view-profiles-btn" class="primary-btn">
                        View AI Profiles & Analysis
                    </button>
                    <button id="export-profiles-btn" class="secondary-btn">
                        Export Profiles CSV
                    </button>
                </div>
            </section>

            <!-- RESULTS SECTION (Single Question) -->
            <section class="results-section" id="results-section" style="display: none;">
                <h2>Results</h2>
                <div id="results-container"></div>
                
                <div id="analysis-section" class="analysis-section" style="display: none;">
                    <h3>Quick Analysis</h3>
                    <div id="analysis-content"></div>
                </div>
            </section>

            <!-- PROFILES SECTION (Batch Results) -->
            <section class="profiles-section" id="profiles-section" style="display: none;">
                <h2>AI Profiles - Comprehensive Analysis</h2>
                
                <div class="profiles-header">
                    <button id="comparison-view-btn" class="view-toggle-btn active">Comparison Matrix</button>
                    <button id="individual-view-btn" class="view-toggle-btn">Individual Profiles</button>
                </div>

                <!-- Comparison Matrix View -->
                <div id="comparison-matrix" class="comparison-matrix">
                    <h3>Side-by-Side Comparison</h3>
                    <div id="comparison-table"></div>
                </div>

                <!-- Individual Profiles View -->
                <div id="individual-profiles" class="individual-profiles" style="display: none;">
                    <div id="profile-cards"></div>
                </div>
            </section>

            <!-- History Section -->
            <section class="history-section">
                <h2>Test History</h2>
                <button id="load-history-btn" class="secondary-btn">Load Recent Tests</button>
                <div id="history-container"></div>
            </section>
        </div>
    </div>

    <script>
        // Global variables
        let currentBatchId = null;
        let currentMode = 'single';

        // Mode switching
        document.getElementById('single-mode-btn').addEventListener('click', () => {
            currentMode = 'single';
            document.getElementById('single-mode-btn').classList.add('active');
            document.getElementById('batch-mode-btn').classList.remove('active');
            document.getElementById('single-mode').style.display = 'block';
            document.getElementById('batch-mode').style.display = 'none';
            document.getElementById('profiles-section').style.display = 'none';
        });

        document.getElementById('batch-mode-btn').addEventListener('click', () => {
            currentMode = 'batch';
            document.getElementById('batch-mode-btn').classList.add('active');
            document.getElementById('single-mode-btn').classList.remove('active');
            document.getElementById('single-mode').style.display = 'none';
            document.getElementById('batch-mode').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
        });

        // Format rating for display
        function formatRating(rating) {
            if (rating === null || rating === undefined) return null;
            const rounded = Math.round(rating * 1000) / 1000;
            return parseFloat(rounded.toFixed(3));
        }

        // Format metric score with interpretation
        function formatMetricScore(score, metricType) {
            if (score === null || score === undefined) return 'N/A';
            
            const formatted = formatRating(score);
            let interpretation = '';
            
            switch(metricType) {
                case 'partisan':
                    if (score < -2) interpretation = ' (Strong Right)';
                    else if (score < -0.5) interpretation = ' (Moderate Right)';
                    else if (score < 0.5) interpretation = ' (Center)';
                    else if (score < 2) interpretation = ' (Moderate Left)';
                    else interpretation = ' (Strong Left)';
                    break;
                case 'safety':
                    if (score > 60) interpretation = ' (Heavily Aligned)';
                    else if (score > 30) interpretation = ' (Moderate)';
                    else interpretation = ' (Loosely Aligned)';
                    break;
                case 'science':
                    if (score > 8.5) interpretation = ' (Strong)';
                    else if (score > 7) interpretation = ' (Moderate)';
                    else interpretation = ' (Weak)';
                    break;
            }
            
            return formatted + interpretation;
        }

        // Toggle analysis details
        function toggleAnalysis(button) {
            const details = button.nextElementSibling;
            if (details.style.display === 'none') {
                details.style.display = 'block';
                button.textContent = 'üìä Hide Analysis Details';
            } else {
                details.style.display = 'none';
                button.textContent = 'üìä Show Analysis Details';
            }
        }

        // Start batch test
        document.getElementById('start-batch-btn').addEventListener('click', async () => {
            if (!confirm('This will run 40 questions across 9 AI systems (~25 minutes). Continue?')) {
                return;
            }

            document.getElementById('start-batch-btn').disabled = true;
            document.getElementById('batch-progress').style.display = 'block';
            
            const testName = `Research Battery - ${new Date().toLocaleDateString()}`;
            
            try {
                const response = await fetch('/batch/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: testName,
                        description: 'Comprehensive 40-question analysis'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentBatchId = data.batch_id;
                    
                    // Show completion
                    document.getElementById('batch-progress').style.display = 'none';
                    document.getElementById('batch-complete').style.display = 'block';
                    
                    alert(`‚úÖ Test complete! Processed ${data.total_responses} responses.`);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting batch test: ' + error.message);
            } finally {
                document.getElementById('start-batch-btn').disabled = false;
            }
        });

        // View profiles after batch complete
        document.getElementById('view-profiles-btn').addEventListener('click', async () => {
            if (!currentBatchId) {
                alert('No batch ID available');
                return;
            }

            try {
                const response = await fetch(`/batch/results/${currentBatchId}`);
                const data = await response.json();
                
                displayProfiles(data.profiles);
            } catch (error) {
                console.error('Error loading profiles:', error);
                alert('Error loading profiles');
            }
        });

        // Export profiles CSV
        document.getElementById('export-profiles-btn').addEventListener('click', () => {
            if (!currentBatchId) {
                alert('No batch ID available');
                return;
            }
            
            window.location.href = `/export/profiles-csv/${currentBatchId}`;
        });

        // Display profiles
        function displayProfiles(profiles) {
            if (!profiles || profiles.length === 0) {
                alert('No profiles available');
                return;
            }

            document.getElementById('profiles-section').style.display = 'block';
            
            // Build comparison matrix
            buildComparisonMatrix(profiles);
            
            // Build individual profile cards
            buildIndividualProfiles(profiles);
            
            // Scroll to profiles
            document.getElementById('profiles-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Build comparison matrix
        function buildComparisonMatrix(profiles) {
            const container = document.getElementById('comparison-table');
            
            let html = '<table class="comparison-table"><thead><tr>';
            html += '<th>Metric</th>';
            
            profiles.forEach(p => {
                html += `<th>${p.ai_system}<br><small>${p.model}</small></th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Rows for each metric
            const metrics = [
                {key: 'partisan_score', label: 'Partisan Lean', type: 'partisan'},
                {key: 'economic_ideology_score', label: 'Economic Ideology', type: 'partisan'},
                {key: 'science_alignment_score', label: 'Science Alignment', type: 'science'},
                {key: 'safety_alignment_score', label: 'Safety Alignment', type: 'safety'},
                {key: 'social_progressivism_score', label: 'Social Values', type: 'partisan'},
                {key: 'ai_optimism_score', label: 'AI Optimism', type: null},
                {key: 'baseline_validity_score', label: 'Baseline Validity', type: null},
                {key: 'refusal_rate', label: 'Refusal Rate %', type: null}
            ];
            
            metrics.forEach(metric => {
                html += `<tr><td class="metric-label">${metric.label}</td>`;
                profiles.forEach(p => {
                    const value = p[metric.key];
                    const formatted = metric.type ? formatMetricScore(value, metric.type) : 
                                     (value !== null ? formatRating(value) : 'N/A');
                    html += `<td>${formatted}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Build individual profile cards
        function buildIndividualProfiles(profiles) {
            const container = document.getElementById('profile-cards');
            let html = '';
            
            profiles.forEach(p => {
                html += `
                    <div class="profile-card">
                        <div class="profile-header">
                            <h3>${p.ai_system} - ${p.model}</h3>
                            <span class="test-date">${p.test_date}</span>
                        </div>
                        
                        <div class="profile-metrics">
                            <div class="metric-grid">
                                <div class="metric-item">
                                    <label>Partisan Lean:</label>
                                    <value>${formatMetricScore(p.partisan_score, 'partisan')}</value>
                                </div>
                                <div class="metric-item">
                                    <label>Economic Ideology:</label>
                                    <value>${formatMetricScore(p.economic_ideology_score, 'partisan')}</value>
                                </div>
                                <div class="metric-item">
                                    <label>Science Alignment:</label>
                                    <value>${formatMetricScore(p.science_alignment_score, 'science')}</value>
                                </div>
                                <div class="metric-item">
                                    <label>Safety Alignment:</label>
                                    <value>${formatMetricScore(p.safety_alignment_score, 'safety')}</value>
                                </div>
                                <div class="metric-item">
                                    <label>Social Values:</label>
                                    <value>${formatMetricScore(p.social_progressivism_score, 'partisan')}</value>
                                </div>
                                <div class="metric-item">
                                    <label>AI Optimism:</label>
                                    <value>${formatRating(p.ai_optimism_score)}</value>
                                </div>
                                <div class="metric-item">
                                    <label>Refusal Rate:</label>
                                    <value>${formatRating(p.refusal_rate)}%</value>
                                </div>
                                <div class="metric-item">
                                    <label>Hedge Frequency:</label>
                                    <value>${formatRating(p.hedge_frequency)}</value>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Toggle profile views
        document.getElementById('comparison-view-btn').addEventListener('click', () => {
            document.getElementById('comparison-view-btn').classList.add('active');
            document.getElementById('individual-view-btn').classList.remove('active');
            document.getElementById('comparison-matrix').style.display = 'block';
            document.getElementById('individual-profiles').style.display = 'none';
        });

        document.getElementById('individual-view-btn').addEventListener('click', () => {
            document.getElementById('individual-view-btn').classList.add('active');
            document.getElementById('comparison-view-btn').classList.remove('active');
            document.getElementById('comparison-matrix').style.display = 'none';
            document.getElementById('individual-profiles').style.display = 'block';
        });

        // SINGLE QUESTION MODE (Original functionality with ENHANCED ANALYSIS DISPLAY)
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const question = document.getElementById('question-input').value.trim();
            
            if (!question) {
                alert('Please enter a question');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ question })
                });

                const data = await response.json();
                displayResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error querying AI systems. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
            }
        });

        // Reset button
        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('question-input').value = '';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('analysis-section').style.display = 'none';
            document.getElementById('question-input').focus();
        });

        // Display single question results WITH ENHANCED ANALYSIS
        function displayResults(data) {
            const container = document.getElementById('results-container');
            const resultsSection = document.getElementById('results-section');
            
            container.innerHTML = '';
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-display';
            questionDiv.innerHTML = `<strong>Question:</strong> ${data.question}`;
            container.appendChild(questionDiv);

            data.results.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                if (result.success) {
                    const rating = formatRating(result.extracted_rating);
                    const ratingDisplay = rating !== null 
                        ? `<div class="rating-badge">Rating: ${rating}/10</div>`
                        : '<div class="rating-badge no-rating">No numerical rating detected</div>';
                    
                    // NEW: Build analysis details if available
                    let analysisHTML = '';
                    if (result.analysis) {
                        const a = result.analysis;
                        analysisHTML = `
                            <div class="analysis-toggle">
                                <button class="analysis-toggle-btn" onclick="toggleAnalysis(this)">
                                    üìä Show Analysis Details
                                </button>
                                <div class="analysis-details" style="display: none;">
                                    <div class="analysis-grid">
                                        <div class="analysis-item">
                                            <label>Word Count:</label>
                                            <value>${a.word_count}</value>
                                        </div>
                                        <div class="analysis-item">
                                            <label>Hedge Frequency:</label>
                                            <value>${a.hedge_frequency}%</value>
                                        </div>
                                        <div class="analysis-item">
                                            <label>Sentiment:</label>
                                            <value>${a.sentiment_score > 0 ? '+' : ''}${a.sentiment_score}</value>
                                        </div>
                                        <div class="analysis-item">
                                            <label>Controversy Words:</label>
                                            <value>${a.controversy_word_count}</value>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <h3>${result.system} - ${result.model}</h3>
                            <span class="response-time">${result.response_time.toFixed(2)}s</span>
                        </div>
                        ${ratingDisplay}
                        ${analysisHTML}
                        <div class="response-text">${result.raw_response}</div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <h3>${result.system} - ${result.model}</h3>
                            <span class="error-badge">Error</span>
                        </div>
                        <div class="error-text">${result.error}</div>
                    `;
                    resultCard.classList.add('error-card');
                }
                
                container.appendChild(resultCard);
            });

            showAnalysis(data.results);
            resultsSection.style.display = 'block';
        }

        // Show analysis
        function showAnalysis(results) {
            const analysisSection = document.getElementById('analysis-section');
            const analysisContent = document.getElementById('analysis-content');
            
            const successfulResults = results.filter(r => r.success);
            const ratingsFound = successfulResults.filter(r => r.extracted_rating !== null);
            
            if (ratingsFound.length === 0) {
                analysisSection.style.display = 'none';
                return;
            }

            const ratings = ratingsFound.map(r => formatRating(r.extracted_rating));
            const average = ratings.reduce((a, b) => a + b, 0) / ratings.length;
            const min = Math.min(...ratings);
            const max = Math.max(...ratings);
            const spread = max - min;
            
            const squaredDiffs = ratings.map(r => Math.pow(r - average, 2));
            const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / ratings.length;
            const stdDev = Math.sqrt(avgSquaredDiff);

            let analysisHTML = `
                <div class="analysis-stats">
                    <div class="stat">
                        <label>Ratings Found:</label>
                        <value>${ratingsFound.length} of ${successfulResults.length}</value>
                    </div>
                    <div class="stat">
                        <label>Average:</label>
                        <value>${average.toFixed(3)}/10</value>
                    </div>
                    <div class="stat">
                        <label>Range:</label>
                        <value>${min.toFixed(3)} - ${max.toFixed(3)}</value>
                    </div>
                    <div class="stat">
                        <label>Spread:</label>
                        <value>${spread.toFixed(3)}</value>
                    </div>
                    <div class="stat">
                        <label>Std Dev:</label>
                        <value>${stdDev.toFixed(3)}</value>
                    </div>
                </div>
            `;

            if (spread === 0) {
                analysisHTML += `
                    <div class="insight consensus">
                        <strong>üìä Perfect Consensus:</strong> All AI systems gave identical ratings (${min.toFixed(3)}/10). 
                        This suggests strong agreement on this particular question.
                    </div>
                `;
            } else if (spread < 0.5) {
                analysisHTML += `
                    <div class="insight consensus">
                        <strong>üìä Strong Consensus:</strong> Ratings are very close (spread: ${spread.toFixed(3)}). 
                        The AI systems largely agree on this topic.
                    </div>
                `;
            } else if (spread < 1.5) {
                analysisHTML += `
                    <div class="insight moderate">
                        <strong>üìä Moderate Variation:</strong> There is a ${spread.toFixed(3)}-point spread between ratings. 
                        Some difference in AI perspectives detected.
                    </div>
                `;
            } else {
                analysisHTML += `
                    <div class="insight divergent">
                        <strong>üìä Significant Divergence:</strong> There is a ${spread.toFixed(3)}-point spread between ratings. 
                        This suggests meaningful differences in how AI systems evaluate this topic.
                    </div>
                `;
            }

            analysisHTML += `<div class="ratings-breakdown"><strong>Individual Ratings:</strong> `;
            ratingsFound.forEach((r, i) => {
                analysisHTML += `${r.system} ${r.model}: ${formatRating(r.extracted_rating)}`;
                if (i < ratingsFound.length - 1) analysisHTML += ' | ';
            });
            analysisHTML += `</div>`;

            analysisContent.innerHTML = analysisHTML;
            analysisSection.style.display = 'block';
        }

        // Load history
        document.getElementById('load-history-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/history');
                const history = await response.json();
                displayHistory(history);
            } catch (error) {
                console.error('Error loading history:', error);
                alert('Error loading history');
            }
        });

        function displayHistory(history) {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="no-history">No queries yet. Try the research battery above!</p>';
                return;
            }

            container.innerHTML = '<div class="history-list"></div>';
            const listDiv = container.querySelector('.history-list');

            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleString();
                
                historyItem.innerHTML = `
                    <div class="history-question">${item.question}</div>
                    <div class="history-meta">
                        <span>${dateStr}</span>
                        <span>${item.response_count} responses</span>
                    </div>
                `;
                
                historyItem.addEventListener('click', () => loadQueryDetails(item.id));
                listDiv.appendChild(historyItem);
            });
        }

        async function loadQueryDetails(queryId) {
            try {
                const response = await fetch(`/query/${queryId}`);
                const data = await response.json();
                
                document.getElementById('question-input').value = data.question;
                
                const formattedData = {
                    question: data.question,
                    results: data.responses.map(r => ({
                        success: true,
                        system: r.ai_system,
                        model: r.model,
                        raw_response: r.raw_response,
                        extracted_rating: r.extracted_rating,
                        response_time: r.response_time,
                        analysis: {
                            word_count: r.word_count,
                            hedge_frequency: r.hedge_frequency,
                            sentiment_score: r.sentiment_score,
                            controversy_word_count: r.controversy_word_count
                        }
                    }))
                };
                
                displayResults(formattedData);
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading query details:', error);
                alert('Error loading query details');
            }
        }
    </script>
</body>
</html>

<!-- I did no harm and this file is not truncated -->

<!DOCTYPE html>
<!--
AI Bias Research Tool - Main Interface
Created: December 13, 2024
Last Updated: December 15, 2024

UPDATES:
- December 15, 2024: Updated to display decimal ratings (up to 3 decimal places)
- December 15, 2024: Updated example question to encourage precise numerical responses
- December 15, 2024: Improved analysis section for decimal comparisons
- December 15, 2024: Added standard deviation calculation for better statistical insight
- December 15, 2024: ADDED! Reset button to clear form and start fresh query
- December 15, 2024: ADDED! Support for 4th AI system (Anthropic Claude 3.5 Sonnet)

Simple, clean interface for querying multiple AI systems and comparing responses.
Designed for research into AI bias detection.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bias Research Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”¬ AI Bias Research Tool</h1>
            <p class="subtitle">Query multiple AI systems to detect bias patterns</p>
        </header>

        <div class="main-content">
            <!-- Query Input Section -->
            <section class="query-section">
                <h2>Ask Your Question</h2>
                <p class="help-text">
                    Tip: Ask questions that require a numerical rating. Example: "If you had to assign a numerical value to how good pizza is, with a number between 1 and 10, what number would you choose?"
                </p>
                <textarea 
                    id="question-input" 
                    placeholder="Enter your question here. For best results, ask for a rating on a scale of 1-10..."
                    rows="4"
                ></textarea>
                <div class="button-group">
                    <button id="submit-btn" class="primary-btn">
                        Query All AI Systems
                    </button>
                    <button id="reset-btn" class="reset-btn">
                        Reset
                    </button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Querying 5 AI systems... This may take 20-25 seconds</p>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="results-section" style="display: none;">
                <h2>Results</h2>
                <div id="results-container"></div>
                
                <!-- Analysis Section -->
                <div id="analysis-section" class="analysis-section" style="display: none;">
                    <h3>Quick Analysis</h3>
                    <div id="analysis-content"></div>
                </div>
            </section>

            <!-- History Section -->
            <section class="history-section">
                <h2>Recent Queries</h2>
                <button id="load-history-btn" class="secondary-btn">Load History</button>
                <div id="history-container"></div>
            </section>
        </div>
    </div>

    <script>
        // Global variables
        let currentResults = null;

        // Format rating for display (up to 3 decimal places, but trim trailing zeros)
        function formatRating(rating) {
            if (rating === null || rating === undefined) {
                return null;
            }
            // Round to 3 decimal places and remove trailing zeros
            const rounded = Math.round(rating * 1000) / 1000;
            return parseFloat(rounded.toFixed(3));
        }

        // Submit query
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const question = document.getElementById('question-input').value.trim();
            
            if (!question) {
                alert('Please enter a question');
                return;
            }

            // Show loading, hide results
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();
                currentResults = data;
                displayResults(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error querying AI systems. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
            }
        });

        // Reset button
        document.getElementById('reset-btn').addEventListener('click', () => {
            // Clear the question input
            document.getElementById('question-input').value = '';
            
            // Hide results section
            document.getElementById('results-section').style.display = 'none';
            
            // Clear results container
            document.getElementById('results-container').innerHTML = '';
            
            // Hide analysis section
            document.getElementById('analysis-section').style.display = 'none';
            
            // Clear current results
            currentResults = null;
            
            // Focus back on input
            document.getElementById('question-input').focus();
        });

        // Display results
        function displayResults(data) {
            const container = document.getElementById('results-container');
            const resultsSection = document.getElementById('results-section');
            
            container.innerHTML = '';
            
            // Show the question
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-display';
            questionDiv.innerHTML = `<strong>Question:</strong> ${data.question}`;
            container.appendChild(questionDiv);

            // Display each AI response
            data.results.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                if (result.success) {
                    const rating = formatRating(result.extracted_rating);
                    const ratingDisplay = rating !== null 
                        ? `<div class="rating-badge">Rating: ${rating}/10</div>`
                        : '<div class="rating-badge no-rating">No numerical rating detected</div>';
                    
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <h3>${result.system} - ${result.model}</h3>
                            <span class="response-time">${result.response_time.toFixed(2)}s</span>
                        </div>
                        ${ratingDisplay}
                        <div class="response-text">${result.raw_response}</div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <h3>${result.system} - ${result.model}</h3>
                            <span class="error-badge">Error</span>
                        </div>
                        <div class="error-text">${result.error}</div>
                    `;
                    resultCard.classList.add('error-card');
                }
                
                container.appendChild(resultCard);
            });

            // Show analysis if we have ratings
            showAnalysis(data.results);
            
            resultsSection.style.display = 'block';
        }

        // Show analysis of ratings
        function showAnalysis(results) {
            const analysisSection = document.getElementById('analysis-section');
            const analysisContent = document.getElementById('analysis-content');
            
            const successfulResults = results.filter(r => r.success);
            const ratingsFound = successfulResults.filter(r => r.extracted_rating !== null);
            
            if (ratingsFound.length === 0) {
                analysisSection.style.display = 'none';
                return;
            }

            const ratings = ratingsFound.map(r => formatRating(r.extracted_rating));
            const average = ratings.reduce((a, b) => a + b, 0) / ratings.length;
            const min = Math.min(...ratings);
            const max = Math.max(...ratings);
            const spread = max - min;
            
            // Calculate standard deviation for more insight
            const squaredDiffs = ratings.map(r => Math.pow(r - average, 2));
            const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / ratings.length;
            const stdDev = Math.sqrt(avgSquaredDiff);

            let analysisHTML = `
                <div class="analysis-stats">
                    <div class="stat">
                        <label>Ratings Found:</label>
                        <value>${ratingsFound.length} of ${successfulResults.length}</value>
                    </div>
                    <div class="stat">
                        <label>Average:</label>
                        <value>${average.toFixed(3)}/10</value>
                    </div>
                    <div class="stat">
                        <label>Range:</label>
                        <value>${min.toFixed(3)} - ${max.toFixed(3)}</value>
                    </div>
                    <div class="stat">
                        <label>Spread:</label>
                        <value>${spread.toFixed(3)}</value>
                    </div>
                    <div class="stat">
                        <label>Std Dev:</label>
                        <value>${stdDev.toFixed(3)}</value>
                    </div>
                </div>
            `;

            // Generate insight based on spread
            if (spread === 0) {
                analysisHTML += `
                    <div class="insight consensus">
                        <strong>ðŸ“Š Perfect Consensus:</strong> All AI systems gave identical ratings (${min.toFixed(3)}/10). 
                        This suggests strong agreement on this particular question.
                    </div>
                `;
            } else if (spread < 0.5) {
                analysisHTML += `
                    <div class="insight consensus">
                        <strong>ðŸ“Š Strong Consensus:</strong> Ratings are very close (spread: ${spread.toFixed(3)}). 
                        The AI systems largely agree on this topic.
                    </div>
                `;
            } else if (spread < 1.5) {
                analysisHTML += `
                    <div class="insight moderate">
                        <strong>ðŸ“Š Moderate Variation:</strong> There is a ${spread.toFixed(3)}-point spread between ratings. 
                        Some difference in AI perspectives detected.
                    </div>
                `;
            } else {
                analysisHTML += `
                    <div class="insight divergent">
                        <strong>ðŸ“Š Significant Divergence:</strong> There is a ${spread.toFixed(3)}-point spread between ratings. 
                        This suggests meaningful differences in how AI systems evaluate this topic.
                    </div>
                `;
            }

            // Show individual ratings breakdown
            analysisHTML += `<div class="ratings-breakdown"><strong>Individual Ratings:</strong> `;
            ratingsFound.forEach((r, i) => {
                analysisHTML += `${r.system} ${r.model}: ${formatRating(r.extracted_rating)}`;
                if (i < ratingsFound.length - 1) analysisHTML += ' | ';
            });
            analysisHTML += `</div>`;

            analysisContent.innerHTML = analysisHTML;
            analysisSection.style.display = 'block';
        }

        // Load history
        document.getElementById('load-history-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/history');
                const history = await response.json();
                displayHistory(history);
            } catch (error) {
                console.error('Error loading history:', error);
                alert('Error loading history');
            }
        });

        // Display history
        function displayHistory(history) {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="no-history">No queries yet. Ask your first question above!</p>';
                return;
            }

            container.innerHTML = '<div class="history-list"></div>';
            const listDiv = container.querySelector('.history-list');

            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleString();
                
                historyItem.innerHTML = `
                    <div class="history-question">${item.question}</div>
                    <div class="history-meta">
                        <span>${dateStr}</span>
                        <span>${item.response_count} responses</span>
                    </div>
                `;
                
                historyItem.addEventListener('click', () => loadQueryDetails(item.id));
                listDiv.appendChild(historyItem);
            });
        }

        // Load query details
        async function loadQueryDetails(queryId) {
            try {
                const response = await fetch(`/query/${queryId}`);
                const data = await response.json();
                
                // Populate the question input
                document.getElementById('question-input').value = data.question;
                
                // Display results
                const formattedData = {
                    question: data.question,
                    results: data.responses.map(r => ({
                        success: true,
                        system: r.ai_system,
                        model: r.model,
                        raw_response: r.raw_response,
                        extracted_rating: r.extracted_rating,
                        response_time: r.response_time
                    }))
                };
                
                displayResults(formattedData);
                
                // Scroll to results
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading query details:', error);
                alert('Error loading query details');
            }
        }
    </script>
</body>
</html>

<!-- I did no harm and this file is not truncated -->
